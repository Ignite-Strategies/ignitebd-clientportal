generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Owner {
  id         String  @id @default(cuid())
  firebaseId String  @unique
  name       String?
  email      String?
  photoURL   String?
  teamSize   String? // Team size for owner context (e.g., "just-me", "2-10", "11-50", "51-200", "200+")

  // Microsoft OAuth integration (bolted directly onto Owner)
  microsoftAccessToken  String? // Microsoft Graph access token
  microsoftRefreshToken String? // Refresh token for getting new access tokens
  microsoftExpiresAt    DateTime? // Token expiration timestamp
  microsoftEmail        String? // Microsoft account email (for display)
  microsoftDisplayName  String? // Microsoft account display name (for display)
  microsoftTenantId     String? // Tenant ID extracted from ID token (for tenant-specific token refresh)

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  managedCompanies CompanyHQ[]     @relation("ManagerOf")
  ownedCompanies   CompanyHQ[]     @relation("OwnerOf")
  emailActivities  EmailActivity[] // Outreach email tracking

  @@map("owners")
}

model EmailActivity {
  id        String   @id @default(cuid())
  ownerId   String   @map("owner_id")
  contactId String?  @map("contact_id")
  tenantId  String?  @map("tenant_id")
  email     String
  subject   String
  body      String
  event     String? // last known state: delivered, opened, clicked, bounced, etc.
  messageId String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner Owner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([messageId])
  @@index([contactId])
  @@map("email_activities")
}

model CompanyHQ {
  id               String        @id @default(cuid())
  companyName      String
  companyStreet    String? // Street address
  companyCity      String? // City
  companyState     String? // State
  companyWebsite   String? // Website URL (for LinkedIn extraction, etc.)
  whatYouDo        String? // What the company does (description)
  companyIndustry  String?
  companyAnnualRev Float?
  yearsInBusiness  Int?
  teamSize         String? // Team size for company (e.g., "just-me", "2-10", "11-50", "51-200", "200+")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  ownerId          String
  managerId        String?
  companies        Company[]
  manager          Owner?        @relation("ManagerOf", fields: [managerId], references: [id])
  owner            Owner         @relation("OwnerOf", fields: [ownerId], references: [id])
  contactLists     ContactList[]
  contacts         Contact[]
  proposals        Proposal[]
  products         Product[]
  personas         Persona[]

  @@map("company_hqs")
}

model Company {
  id              String        @id @default(cuid())
  companyHQId     String
  companyName     String
  address         String?
  industry        String?
  website         String? // Website URL (inferred from email domain or manually entered)
  revenue         Float?
  yearsInBusiness Int?
  proposalId      String?
  contractId      String?
  invoiceId       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  companyHQ       CompanyHQ     @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  contacts        Contact[]
  proposals       Proposal[] // Reverse relation - proposals linked to this company
  workPackages    WorkPackage[]

  @@map("companies")
}

model ContactList {
  id          String    @id @default(cuid())
  companyId   String
  name        String
  description String?
  type        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  companyHQ   CompanyHQ @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contacts    Contact[]

  @@map("contact_lists")
}

model Contact {
  id               String                  @id @default(cuid())
  crmId            String // CompanyHQId (tenant identifier) - renamed from companyId for clarity
  firebaseUid      String?                 @unique // Firebase UID - bridge between Firebase Auth and Contact
  firstName        String?
  lastName         String?
  goesBy           String?
  email            String?
  phone            String?
  title            String?
  contactCompanyId String? // Company they work for (prospect/client company)
  buyerDecision    String?
  howMet           String?
  notes            String? // Notes/context about the contact
  contactListId    String?
  role             String? // Contact role: "contact" | "owner" (for elevation flow)
  ownerId          String? // If elevated to owner, link to Owner record
  isActivated      Boolean                 @default(false) // Whether contact has activated portal access
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  companyHQ        CompanyHQ               @relation(fields: [crmId], references: [id])
  contactCompany   Company?                @relation(fields: [contactCompanyId], references: [id])
  contactList      ContactList?            @relation(fields: [contactListId], references: [id])
  pipeline         Pipeline?
  deliverables     ConsultantDeliverable[]
  workPackages     WorkPackage[]

  @@index([firebaseUid]) // Index for fast lookups
  @@map("contacts")
}

model Product {
  id                    String    @id @default(cuid())
  companyHQId           String
  name                  String
  description           String?
  valueProp             String?
  price                 Float? // Price in base currency
  priceCurrency         String?   @default("USD") // Currency code (USD, EUR, etc.)
  pricingModel          String? // one-time, recurring, usage-based, freemium, custom
  category              String? // Category or type of product/service
  deliveryTimeline      String? // How long it takes to deliver
  targetMarketSize      String? // enterprise, mid-market, small-business, startup, individual
  salesCycleLength      String? // immediate, short, medium, long, very-long
  features              String? // Key features (free text)
  competitiveAdvantages String? // Competitive advantages (free text)
  targetedTo            String? // Persona ID that this product is targeted to
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  companyHQ             CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  personas              Persona[]

  @@map("products")
}

model Pipeline {
  id        String   @id @default(cuid())
  contactId String   @unique
  pipeline  String
  stage     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@map("pipelines")
}

model Proposal {
  id          String    @id @default(cuid())
  companyHQId String // Multi-tenancy - scoped to CompanyHQ
  companyHQ   CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)

  // Client information
  clientName    String
  clientCompany String // Company name (can link to Company model later via companyId)
  companyId     String? // Optional: Link to Company model (prospect/client company)
  company       Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  // Proposal details
  purpose    String? // Purpose/description of the proposal
  status     String  @default("draft") // "draft" | "active" | "approved" | "rejected"
  totalPrice Float? // Total price of all services

  // Proposal structure (stored as JSON for flexibility)
  serviceInstances Json? // Array of ProposalServiceInstance (from ProposalBuilder)
  phases           Json? // Array of Phase objects (with deliverables, activities, kpis)
  milestones       Json? // Array of Milestone objects (week, label, completed)
  compensation     Json? // Compensation object (total, currency, breakdown, paymentSchedule)

  // Metadata
  dateIssued DateTime? // Date proposal was issued
  preparedBy String? // Who prepared the proposal

  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  deliverables ConsultantDeliverable[]
  invoices     Invoice[]

  @@map("proposals")
}

model Persona {
  id                 String    @id @default(cuid())
  companyHQId        String
  name               String
  role               String?
  title              String?
  industry           String?
  goals              String?
  painPoints         String?
  desiredOutcome     String?
  valuePropToPersona String?
  alignmentScore     Int?
  productId          String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  companyHQ          CompanyHQ @relation(fields: [companyHQId], references: [id], onDelete: Cascade)
  product            Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@map("personas")
}

model ConsultantDeliverable {
  id        String  @id @default(cuid())
  contactId String // Link to Contact (the client)
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // What we're delivering
  title       String
  description String?
  category    String? // "foundation", "integration", "enrichment", etc.

  // Status tracking
  status String @default("pending") // "pending" | "in-progress" | "completed" | "blocked"

  // Link to proposal/milestone
  proposalId  String?
  proposal    Proposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  milestoneId String? // Reference to milestone in Proposal.milestones JSON (e.g., "milestone-1", "week-4")

  // Delivery tracking
  dueDate     DateTime?
  completedAt DateTime?
  notes       String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contactId])
  @@index([proposalId])
  @@map("consultant_deliverables")
}

model Invoice {
  id         String   @id @default(cuid())
  proposalId String
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  // Invoice details
  invoiceNumber String  @unique // Human-readable invoice number (e.g., "INV-2025-001")
  amount        Float // Amount in dollars (e.g., 500.00)
  currency      String  @default("USD")
  description   String? // Invoice description/notes

  // Payment schedule reference
  paymentScheduleId String? // Reference to payment in Proposal.compensation.paymentSchedule (e.g., "payment-1")
  week              Int? // Week number from payment schedule
  trigger           String? // Payment trigger (e.g., "Kickoff", "Week 4", "Completion")

  // Payment status
  status String @default("pending") // "pending" | "paid" | "failed" | "refunded"

  // Stripe integration
  stripeCheckoutSessionId String? @unique // Stripe checkout session ID
  stripePaymentIntentId   String? @unique // Stripe payment intent ID
  stripeCustomerId        String? // Stripe customer ID
  
  // Who paid (from checkout session metadata)
  paidByContactId String? // Contact ID who made the payment

  // Dates
  dueDate   DateTime? // When payment is due
  paidAt    DateTime? // When payment was completed
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([proposalId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// Work Package Models (for client portal access to work packages)
model WorkPackage {
  id        String   @id @default(cuid())
  contactId String
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  title              String
  description        String?
  totalCost          Float?
  effectiveStartDate DateTime?

  phases WorkPackagePhase[]
  items  WorkPackageItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contactId])
  @@index([companyId])
  @@map("work_packages")
}

model WorkPackagePhase {
  id            String      @id @default(cuid())
  workPackageId String
  workPackage   WorkPackage @relation(fields: [workPackageId], references: [id], onDelete: Cascade)

  name                String
  position            Int
  description         String?
  totalEstimatedHours Int?

  items WorkPackageItem[]

  createdAt DateTime @default(now())

  @@unique([workPackageId, name, position])
  @@index([workPackageId])
  @@index([position])
  @@map("work_package_phases")
}

model WorkPackageItem {
  id                 String           @id @default(cuid())
  workPackageId      String
  workPackage        WorkPackage      @relation(fields: [workPackageId], references: [id], onDelete: Cascade)
  workPackagePhaseId String
  workPackagePhase   WorkPackagePhase @relation(fields: [workPackagePhaseId], references: [id], onDelete: Cascade)

  deliverableType        String
  deliverableLabel       String
  deliverableDescription String?

  quantity           Int
  unitOfMeasure      String
  estimatedHoursEach Int
  status             String @default("not_started")

  artifacts WorkArtifact[]

  createdAt DateTime @default(now())

  @@unique([workPackageId, workPackagePhaseId, deliverableLabel])
  @@index([workPackageId])
  @@index([workPackagePhaseId])
  @@index([deliverableType])
  @@index([status])
  @@map("work_package_items")
}

model WorkArtifact {
  id                String          @id @default(cuid())
  workPackageItemId String
  workPackageItem   WorkPackageItem @relation(fields: [workPackageItemId], references: [id], onDelete: Cascade)

  type        String // BLOG | PERSONA | CLE_DECK | TEMPLATE | ETC
  title       String?
  contentJson Json?

  status String // DRAFT | IN_REVIEW | APPROVED | COMPLETED

  reviewRequestedAt DateTime?
  reviewCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workPackageItemId])
  @@index([status])
  @@index([type])
  @@map("work_artifacts")
}
